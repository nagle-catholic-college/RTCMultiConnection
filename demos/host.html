<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8">
  <title>Screen Sharing using RTCMultiConnection</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
  <link rel="shortcut icon" href="/demos/logo.png">
  <link rel="stylesheet" href="/demos/stylesheet.css">
  <script src="/demos/menu.js"></script>
</head>
<body>
<div id="videos-container" style="margin: 20px 0;"></div>

<script src="/dist/RTCMultiConnection.js"></script>
<script src="/node_modules/webrtc-adapter/out/adapter.js"></script>
<script src="/socket.io/socket.io.js"></script>

<link rel="stylesheet" href="/dev/getHTMLMediaElement.css">
<script src="/dev/getHTMLMediaElement.js"></script>

<script>
const queryString = window.location.search;
const urlParams = new URLSearchParams(queryString);
const roomid = urlParams.get('roomid')

screenConnection = new RTCMultiConnection();
audioConnection = new RTCMultiConnection();

videoConstraints = {
    width: {
        ideal: 1920
    },
    height: {
        ideal: 1080
    },
    frameRate: {min: 24, max: 30}
};

screenConnection.session = {
<<<<<<< HEAD
     screen: false,
     oneway: false
=======
     screen: true,
     oneway: true
>>>>>>> parent of 339306f... stuff
};

audioConnection.session = {
     audio: false,
};

screenConnection.mediaConstraints = {
    video: videoConstraints,
    audio: false
};


screenConnection.openOrJoin(roomid + '-screen');
audioConnection.openOrJoin(roomid + '-audio');

screenConnection.onNewParticipant = function(participantId, userPreferences) {
    // if OfferToReceiveAudio/OfferToReceiveVideo should be enabled for specific users
    userPreferences.localPeerSdpConstraints.OfferToReceiveAudio = true;
    userPreferences.localPeerSdpConstraints.OfferToReceiveVideo = true;

    userPreferences.dontAttachStream = false; // according to situation
    userPreferences.dontGetRemoteStream = false;  // according to situation

    // below line must be included. Above all lines are optional.
    // if below line is NOT included; "join-request" will be considered rejected.
    screenConnection.acceptParticipationRequest(participantId, userPreferences);
};

// or do not allow a user twice
var alreadyAllowed = {};
screenConnection.onNewParticipant = function(participantId, userPreferences) {
    if(alreadyAllowed[participantId]) {
        screenConnection.addParticipationRequest(participantId, userPreferences);
        return;
    }

    var message = participantId + ' is trying to join your room. Confirm to accept his request.';
    if( window.confirm(messsage ) ) {
        screenConnection.addParticipationRequest(participantId, userPreferences);
    }
};

screenConnection.videosContainer = document.getElementById('videos-container');
screenConnection.onstream = function(event) {
    var existing = document.getElementById(event.streamid);
    if(existing && existing.parentNode) {
      existing.parentNode.removeChild(existing);
    }

    //event.mediaElement.removeAttribute('src');
    //event.mediaElement.removeAttribute('srcObject');
    //event.mediaElement.muted = true;
    //event.mediaElement.volume = 1;

    var video = document.createElement('video');

    try {
        video.setAttributeNode(document.createAttribute('autoplay'));
    } catch (e) {
        video.setAttribute('autoplay', true);
    }

    if(event.type === 'local') {
      video.volume = 0;
      try {
          video.setAttributeNode(document.createAttribute('muted'));
      } catch (e) {
          video.setAttribute('muted', false);
      }
    }
    video.srcObject = event.stream;

    var width = innerWidth - 80;
    var mediaElement = getHTMLMediaElement(video, {
        width: width,
        showOnMouseEnter: true
    });

    screenConnection.videosContainer.appendChild(mediaElement);

    setTimeout(function() {
        mediaElement.media.play();
    }, 3000);

    mediaElement.id = event.streamid;
};
</script>
</body>