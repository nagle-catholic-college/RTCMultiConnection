<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8">
  <title>Screen Sharing using RTCMultiConnection</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
  <link rel="shortcut icon" href="/demos/logo.png">
  <link rel="stylesheet" href="/demos/stylesheet.css">
  <script src="/demos/menu.js"></script>
</head>
<body>
<div id="videos-container" style="margin: 20px 0;"></div>

<script src="/dist/RTCMultiConnection.js"></script>
<script src="/node_modules/webrtc-adapter/out/adapter.js"></script>
<script src="/socket.io/socket.io.js"></script>

<link rel="stylesheet" href="/dev/getHTMLMediaElement.css">
<script src="/dev/getHTMLMediaElement.js"></script>
<script src="/dev/BandwidthHandler.js"></script>

<script>
const queryString = window.location.search;
const urlParams = new URLSearchParams(queryString);
const roomid = urlParams.get('roomid')

connection = new RTCMultiConnection();

videoConstraints = {
    width: {
        ideal: 1680
    },
    height: {
        ideal: 1050
    },
    frameRate: {min: 24, max: 30}
};


connection.session = {
     screen: true,
     audio: true,
     oneway: true
};

connection.mediaConstraints = {
    video: videoConstraints,
    audio: true
};

connection.processSdp = function() {
    // here is how to use it
    var bandwidth = {
        screen: 3000, // 300kbits minimum
        audio: 500 // 50kbits  minimum
    };
    var isScreenSharing = !!connection.session.screen;

    sdp = BandwidthHandler.setApplicationSpecificBandwidth(sdp, bandwidth, isScreenSharing);
    sdp = BandwidthHandler.setOpusAttributes(sdp, {
        'stereo': 0, // to disable stereo (to force mono audio)
        'sprop-stereo': 1,
        'maxaveragebitrate': 500 * 1024 * 8, // 500 kbits
        'maxplaybackrate': 500 * 1024 * 8, // 500 kbits
        'cbr': 0, // disable cbr
        'useinbandfec': 1, // use inband fec
        'usedtx': 1, // use dtx
        'maxptime': 3
    });
    return sdp;
};


connection.openOrJoin(roomid + '-screen');

connection.videosContainer = document.getElementById('videos-container');
connection.onstream = function(event) {
    var existing = document.getElementById(event.streamid);
    if(existing && existing.parentNode) {
      existing.parentNode.removeChild(existing);
    }

    var video = document.createElement('video');

    try {
        video.setAttributeNode(document.createAttribute('autoplay'));
    } catch (e) {
        video.setAttribute('autoplay', true);
    }

    video.srcObject = event.stream;

    var width = innerWidth - 80;
    var mediaElement = getHTMLMediaElement(video, {
        width: width,
        showOnMouseEnter: true
    });

    connection.videosContainer.appendChild(mediaElement);

    setTimeout(function() {
        mediaElement.media.play();
    }, 5000);

    mediaElement.id = event.streamid;
};
</script>
</body>